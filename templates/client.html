<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">
  <link rel="icon" href="../../../../favicon.ico">
  <title>Kiki</title>
  <!-- Bootstrap core CSS -->
  <link href="/static/bootstrap.min.css" rel="stylesheet">
  <!-- Custom styles for this template -->
  <link href="/static/blog.css" rel="stylesheet">
  <script defer src="/static/all.js"></script>
  <link href="/static/toastr.css" rel="stylesheet" />
  <link rel="stylesheet" href="/static/medium-editor.min.css" type="text/css" media="screen" charset="utf-8">
  <link href="/static/bootstrap.medium.css" rel="stylesheet" />
</head>

<body>
  <header>
    <div class="blog-masthead">
      <div class="container">
        <nav class="nav">
          <a class="nav-link active" href="/">Kiki</a>
          <!-- <a class="nav-link" href="#">Help</a>
          <a class="nav-link" href="#">About</a> -->
        </nav>
      </div>
    </div>
    <!--         <div class="blog-header">
                <div class="container">
                    <h1 class="blog-title">The Bootstrap Blog</h1>
                    <p class="lead blog-description">An example blog template built with Bootstrap.</p>
                </div>
            </div>
        -->
  </header>
  <main role="main" class="container">
    <input type=hidden id="letterPurpose" value="" />
    <input type=hidden id="letterReplyTo" value="" />
    <input type=hidden id="letterReplaces" value="" />
    <!-- begin medium modal -->
    <!-- Modal -->
    <div class="modal fade" id="writingModal" role="dialog" aria-labelledby="writingModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content"  id="writingModalBody">
          <div class="modal-header">
            <h5 class="modal-title" id="writingModalLabel"></h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
          </div>
          <div class="modal-body">
            <div class="editable">
              <p>My fatherâ€™s family name being
                <a href="https://en.wikipedia.org/wiki/Pip_(Great_Expectations)">Pirrip</a>, and my Christian name Philip, my infant tongue could make of both names nothing longer or more explicit than Pip. So, I called myself Pip, and came to be called
                Pip.
              </p>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <div class="btn-group btn-group-toggle" data-toggle="buttons">
              <label class="btn btn-info">
                                        <input type="radio" name="options" id="writingToSelf" autocomplete="off">Self
                                    </label>
              <label class="btn btn-info">
                                        <input type="radio" name="options" id="writingToFriends" autocomplete="off"> Friends
                                    </label>
              <label class="btn btn-info active">
                                        <input type="radio" name="options" id="writingToPublic" autocomplete="off" checked> Public
                                    </label>
            </div>
            <button type="button" class="btn btn-primary" id="submit-writing">Submit</button>
          </div>
        </div>
      </div>
    </div>
    <!-- end medium modal -->
    <!-- Modal -->
    <div class="modal fade" id="nameModal" role="dialog" aria-labelledby="nameModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="nameModalLabel"><img id="modalNameImage" src="" class="align-middle profile-pic">&nbsp;
                                <span id="modalNameName">Mark</span> <br><small class="text-muted" style="font-size: 70%;" id="modalNamePublicKey">aasdlkfjas9jf93jfa</small></h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                                </button>
          </div>
          <div class="modal-body">
            <span id="modalNameContent">
                                    I enjoy skiing and driving around!
                                </span>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-info">Filter</button>
            <button type="button" class="btn btn-primary" id="followButton">Follow</button>
            <button type="button" class="btn btn-danger">Block</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-sm-9 blog-main">

         <div id="posts"></div>

        <!-- /.blog-post -->
        <nav class="blog-pagination">
          <a class="btn btn-outline-primary" href="#">Older</a>
          <a class="btn btn-outline-secondary disabled" href="#">Newer</a>
        </nav>
      </div>
      <!-- /.blog-main -->
      <aside class="col-sm-3 ml-sm-auto blog-sidebar">
        <div class="sidebar-module sidebar-module-inset">
          <img src="/img/{{ .User.Image }}">
          <h4><div id="current-name">{{ .User.Name }}</div></h4>
          <div id="current-profile">
            {{ .User.Profile }}
          </div>
        </div>
        <div class="sidebar-module">
          <h4>Actions</h4>
          <ol class="list-unstyled">
            <li><a href="#!" class="editmodal" data-title="Write a post" data-purpose="share-text">Write</a></li>
            <li><a href="#!" class="editmodal" data-title="Edit profile" data-purpose="assign-profile" data-usecontent="current-profile">Edit profile</a></li>
            <li><a href="#"  class="editmodal" data-title="Update image" data-purpose="assign-image" data-makecontent="Drag and drop an image...">Upload image</a></li>
            <li><a href="#!" class="editmodal" data-title="Change name" data-purpose="assign-name" data-usecontent="current-name">Change name</a></li>
          </ol>
        </div>
        <div class="sidebar-module">
          <h4>Friends</h4>
          <ol class="list-unstyled">
            <li><a href="#">TODO</a></li>
          </ol>
        </div>
      </aside>
      <!-- /.blog-sidebar -->
    </div>
    <!-- /.row -->
  </main>
  <!-- /.container -->
  <footer class="blog-footer">
    <p>Blog template built for <a href="https://getbootstrap.com/">Bootstrap</a> by <a href="https://twitter.com/mdo">@mdo</a>.</p>
    <p>
      <a href="#">Back to top</a>
    </p>
  </footer>
  <!-- Bootstrap core JavaScript
    ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
  <script src="/static/jquery-3.2.1.min.js"></script>
  <script src="/static/popper.min.js"></script>
  <script src="/static/bootstrap.min.js"></script>
  <script src="/static/medium-editor.min.js"></script>
  <script src="/static/toastr.min.js"></script>
  <script>

var KiKiApi = function() {}

KiKiApi.prototype.fetch = function(ajaxObj){
    $.ajax(ajaxObj);
}

KiKiApi.prototype.onError = function(toast_msg, callback){
    return function(xhr, status, err) {
        if (xhr.responseJSON.error) {
            err = xhr.responseJSON.error;
        }
        toast_msg && toastr.error(err, toast_msg || 'Error');
        if (!err.stack) {
            err = new Error(err)
        }
        callback && callback(err);
    }
}

KiKiApi.prototype.onSuccess = function(toast_msg, callback){
    return function(data, status, xhr) {
        if ("ok" != data.status) {
            toast_msg && toastr.error(data.error, toast_msg || 'Error');
            callback && callback(new Error(data.error));
        }
        toast_msg && toastr.success(data.message, toast_msg);
        callback && callback(null, data);
    }
}

KiKiApi.prototype.submitLetter = function(letter, callback) {
    var self = this;
    var toast_msg = "Posting to KiKi";
    $.ajax({
        url: "/letter",
        method: "POST",
        data: JSON.stringify(letter),
        contentType: "application/json",
        error: self.onError(toast_msg, callback),
        success: self.onSuccess(toast_msg, callback)
    });
}

KiKiApi.prototype.fetchPosts = function(callback) {
    var self = this;
    $.ajax({
        url: "/api/v1/posts",
        method: "GET",
        error: self.onError(null, callback),
        success: self.onSuccess(null, callback)
    });
}

KiKiApi.prototype.fetchPost = function(post_id, callback) {
    var self = this;
    $.ajax({
        url: "/api/v1/post/"+post_id,
        method: "GET",
        error: self.onError(null, callback),
        success: self.onSuccess(null, callback)
    });
}

KiKiApi.prototype.fetchPostComments = function(post_id, callback) {
    var self = this;
    $.ajax({
        url: "/api/v1/post/"+post_id+"/comments",
        method: "GET",
        error: self.onError(null, callback),
        success: self.onSuccess(null, callback)
    });
}


var KiKiClient = function(api){
    this.api = api;
    this.posts = [];
    this.$el = $("#posts");
    this.init();
}

KiKiClient.prototype.buildPostCommentsUi = function(post_id) {
    // $('div[post_id="'+post_id'"] .post-comments')
    this.api.fetchPostComments(post_id, function(err, res){
        if (err) throw err;
        console.log(res.data.posts);
    });
};

KiKiClient.prototype.buildPostUi = function(post) {
    var self = this;
    return $("<div>", {post_id: post.id}).addClass("card").append(
        $("<div>").addClass("card-body").append(
            $("<div>").addClass("blog-post").append(

                $("<p>").addClass("blog-post-meta").append(
                    $("<span>").addClass("float-right").append(
                        "&nbsp;",
                        $("<a>", {
                            'href': "#!",
                            'title': "Reply to USERNAME",
                            'data-title': "Reply to USERNAME",
                            'data-replyto': post.id,
                            'data-purpose':"share-text"
                        }).addClass("editmodal").append(
                            $('<i>').addClass("fas fa-reply")
                        ),
                        "&nbsp;",
                        $("<a>", {
                            'href': "#!",
                            'title': "Edit post",
                            'data-title':"Edit post",
                            'data-usecontent':post.id,
                            'data-replaces':post.id,
                            'data-purpose':"share-text"

                        }).addClass("editmodal").append(
                            $("<i>").addClass("fas fa-edit")
                        ),
                        "&nbsp;",
                        $("<a>",  {
                            'href': "#!",
                            "data-id":post.id
                        }).addClass("likebutton").append(
                            $("<i>").addClass("fas fa-heart"),
                            "x"+(post.Likes||1)
                        )
                    ),

                    $("<img>", {src:"/img/POSTUSERIMAGE"}).addClass("align-middle profile-pic"),
                    $("<a>",{
                        'href':"#!",
                        'data-name': "POSTUSERNAME",
                        'data-image': "/img/POSTUSERIMAGE",
                        'data-publickey': post.owner_id,
                        'data-content': "POSTUSERPROFILE"
                    }).addClass("activatenamemodal").append(
                         post.username || post.owner_id
                    ),

                    "to" + post.recipients,
                    "<br>",
                    $("<span>").addClass('text-muted').append(
                        $('<a>', {href:'/?id='+post.id}).append(
                            new Date(post.timestamp*1000)
                        )
                    )
                ),

                $('<hr>'),
                $('<div>', {id:post.id}).append(post.content),
                $('<div>').addClass('post-comments').append(
                    (function(){
                        if (0 == post.num_comments) return;
                        self.buildPostCommentsUi(post.id);
                        return;
                    })()
                )
            )


        )
    );
}

KiKiClient.prototype.buildPostsUi = function() {
    for (var i=0; i<this.posts.length; i++) {
        this.$el.append(
            this.buildPostUi(this.posts[i])
        );
    }
}

KiKiClient.prototype.init = function(){
    var self = this;
    this.api.fetchPosts(function(err,res){
        if (err) {
            throw err;
        }
        self.posts = res.data.posts;
        self.buildPostsUi();
    });
}

var app = {}
app.Api = new KiKiApi();
app.Client = new KiKiClient(app.Api);





    toastr.options = {
      "closeButton": true,
      "debug": false,
      "newestOnTop": false,
      "progressBar": false,
      "positionClass": "toast-bottom-center",
      "preventDuplicates": false,
      "onclick": null,
      "showDuration": "300",
      "hideDuration": "1000",
      "timeOut": "5000",
      "extendedTimeOut": "1000",
      "showEasing": "swing",
      "hideEasing": "linear",
      "showMethod": "fadeIn",
      "hideMethod": "fadeOut"
    }
    var editor = new MediumEditor('.editable', {
      toolbar: {
        relativeContainer: document.querySelector("#writingModalBody"),
        allowMultiParagraphSelection: true,
        buttons: ['bold', 'italic', 'underline', 'anchor', 'h2', 'h3', 'quote'],
        diffLeft: 0,
        diffTop: -10,
        firstButtonClass: 'medium-editor-button-first',
        lastButtonClass: 'medium-editor-button-last',
        standardizeSelectionStart: false,
        static: true,
        autoLink: true,
        /* options which only apply when static is true */
        align: 'center',
        sticky: false,
        updateOnEmptySelection: false
      }
    });
    $(document).ready(function() {
      $("img").addClass("img-fluid");
      $("#submit-writing").click(function(event) {
        // Stop form from submitting normally
        event.preventDefault();
        letter = {
          "purpose": $("#letterPurpose").val(),
          "replaces": $("#letterReplaces").val(),
          "reply_to": $("#letterReplyTo").val(),
          "to": ["self"],
          "content": editor.getContent(),
        }
        if ($("#writingToPublic").is(":checked") == true) {
          letter["to"] = ["public"];
        }
        if ($("#writingToFriends").is(":checked") == true) {
          letter["to"] = ["friends"];
        }
        console.log(letter);
        app.Api.submitLetter(letter);
      });
      $(".editmodal").click(function() {
        $("#writingModal").modal();
        console.log($(this).data('title'));
        $("#writingModalLabel").text($(this).data('title'));
        $(".editable").focus(function() {
          $(this).select();
        });
        console.log($(this).data("usecontent"));
        if ($(this).data("usecontent")) {
          $(".editable").html($("#" + $(this).data("usecontent")).html())
        } else {
          $(".editable").text("Write your post...");
        }
        if ($(this).data("makecontent")) {
          $(".editable").html($(this).data("makecontent"));
        }
        if ($(this).data("replyto")) {
          $("#letterReplyTo").val($(this).data("replyto"));
        } else {
          $("#letterReplyTo").val("");
        }
        if ($(this).data("replaces")) {
          $("#letterReplaces").val($(this).data("replaces"));
        } else {
          $("#letterReplaces").val("");
        }
        $("#letterPurpose").val($(this).data("purpose"));
      });
      $(".activatenamemodal").click(function() {
        console.log($(this).data("name"));
        $("#modalNameName").text($(this).data("name"));
        $("#modalNamePublicKey").text($(this).data("publickey"));
        $("#modalNameContent").html($(this).data("content"));
        $("#modalNameImage").attr("src",$(this).data("image"));
        $("#nameModal").modal();
        $("#followButton").attr("data-publickey", $(this).data("publickey"));
      });
      $("#followButton").click(function() {
        console.log($(this).data("publickey"));
        // TODO: MAKE A FOLLOW!
      });
      var restrictInput = function(event) {
        $("img:not(.img-fluid)").addClass("img-fluid");
      }
      editor.on(document.querySelector(".editable"), 'keypress', restrictInput);
    });
  </script>
</body>

</html>
