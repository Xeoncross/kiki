<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">
  <link rel="icon" href="../../../../favicon.ico">
  <title>Kiki</title>
  <!-- Bootstrap core CSS -->
  <link href="/static/bootstrap.min.css" rel="stylesheet">
  <!-- Custom styles for this template -->
  <link href="/static/blog.css" rel="stylesheet">
  <script defer src="/static/all.js"></script>
  <link href="/static/toastr.css" rel="stylesheet" />
  <link rel="stylesheet" href="/static/medium-editor.min.css" type="text/css" media="screen" charset="utf-8">
  <link href="/static/bootstrap.medium.css" rel="stylesheet" />


    <style>
        #posts {
            font-size: 16px;
        }

        .post-datetime {
            font-size: 14px;
        }

        #posts img.profile-pic {
            max-width: 25px;
            max-height: 25px;
        }

        #posts .card-body {
            padding: 0.75rem;
        }

        #posts .card {
            margin-bottom: 0.75rem;
        }

        .recipient {
            margin-left: 2px;
            margin-right: 2px;
        }

        .post-comments {
            padding-left: 16px;
        }

        .post-container {
            width: 100%;
        }

        #posts a {
            text-decoration: none;
        }

        .users-list {
            max-height: 300px;
            overflow-y: scroll;
        }

    </style>

</head>

<body>
  <header>
    <div class="blog-masthead">
      <div class="container">
        <nav class="nav">
          <a class="nav-link active" href="/">Kiki</a>
          <!-- <a class="nav-link" href="#">Help</a>
          <a class="nav-link" href="#">About</a> -->
        </nav>
      </div>
    </div>
    <!--         <div class="blog-header">
                <div class="container">
                    <h1 class="blog-title">The Bootstrap Blog</h1>
                    <p class="lead blog-description">An example blog template built with Bootstrap.</p>
                </div>
            </div>
        -->
  </header>
  <main role="main" class="container">
    <input type=hidden id="letterPurpose" value="" />
    <input type=hidden id="letterReplyTo" value="" />
    <input type=hidden id="letterReplaces" value="" />
    <!-- begin medium modal -->
    <!-- Modal -->
    <div class="modal fade" id="writingModal" role="dialog" aria-labelledby="writingModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content"  id="writingModalBody">
          <div class="modal-header">
            <h5 class="modal-title" id="writingModalLabel"></h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
          </div>
          <div class="modal-body">
            <div class="editable">
              <p>My fatherâ€™s family name being
                <a href="https://en.wikipedia.org/wiki/Pip_(Great_Expectations)">Pirrip</a>, and my Christian name Philip, my infant tongue could make of both names nothing longer or more explicit than Pip. So, I called myself Pip, and came to be called
                Pip.
              </p>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <div class="btn-group btn-group-toggle" data-toggle="buttons">
              <label class="btn btn-info">
                                        <input type="radio" name="options" id="writingToSelf" autocomplete="off">Self
                                    </label>
              <label class="btn btn-info">
                                        <input type="radio" name="options" id="writingToFriends" autocomplete="off"> Friends
                                    </label>
              <label class="btn btn-info active">
                                        <input type="radio" name="options" id="writingToPublic" autocomplete="off" checked> Public
                                    </label>
            </div>
            <button type="button" class="btn btn-primary" id="submit-writing">Submit</button>
          </div>
        </div>
      </div>
    </div>
    <!-- end medium modal -->
    <!-- Modal -->
    <div class="modal fade" id="nameModal" role="dialog" aria-labelledby="nameModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="nameModalLabel"><img id="modalNameImage" src="" class="align-middle profile-pic">&nbsp;
                                <span id="modalNameName">Mark</span> <br><small class="text-muted" style="font-size: 70%;" id="modalNamePublicKey">aasdlkfjas9jf93jfa</small></h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                                </button>
          </div>
          <div class="modal-body">
            <span id="modalNameContent"></span>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-info">Filter</button>
            <button type="button" class="btn btn-primary" id="followButton">Follow</button>
            <button type="button" class="btn btn-danger">Block</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-sm-9 blog-main">

         <div id="posts"></div>

        <!-- /.blog-post -->
        <nav class="blog-pagination">
          <a class="btn btn-outline-primary" href="#">Older</a>
          <a class="btn btn-outline-secondary disabled" href="#">Newer</a>
        </nav>
      </div>
      <!-- /.blog-main -->
      <aside class="col-sm-3 ml-sm-auto blog-sidebar">
        <div class="sidebar-module sidebar-module-inset">
          <img id="user-profile-image" class="user-profile-image">
          <h4><div id="user-name"></div></h4>
          <div id="user-profile"></div>
        </div>
        <div class="sidebar-module user-info">
          <h4>Actions</h4>
          <ol class="list-unstyled">
            <!-- <li><a href="#!" class="editmodal" data-title="Write a post" data-purpose="share-text">Write</a></li>
            <li><a href="#!" class="editmodal" data-title="Edit profile" data-purpose="action-assign/profile" data-usecontent="current-profile">Edit profile</a></li>
            <li><a href="#"  class="editmodal" data-title="Update image" data-purpose="action-assign/image" data-makecontent="Drag and drop an image...">Upload image</a></li>
            <li><a href="#!" class="editmodal" data-title="Change name" data-purpose="action-assign/name" data-usecontent="current-name">Change name</a></li> -->


            <li><a href="#!" class="editmodal" data-title="Write a post" data-purpose="share-text"><i class="fas fa-pencil-alt"></i>&nbsp; Share</a></li>
            <li><a href="#!" class="editmodal" data-title="Edit profile" data-purpose="action-assign/profile" data-usecontent="current-profile"><i class="fas fa-child"></i>&nbsp;
            Edit profile</a></li>
            <li><a href="#" class="editmodal" data-title="Update image" data-purpose="action-assign/image" data-makecontent="Drag and drop an image..."><i class="fas fa-upload"></i>&nbsp;
            Change profile image</a></li>
            <li><a href="#!" class="editmodal" data-title="Change name" data-purpose="action-assign/name" data-usecontent="current-name"><i class="fas fa-comment-alt"></i>&nbsp;
            Change name</a></li>
            <li><a href="#!" class="addserver"><i class="fas fa-plus-circle"></i>&nbsp;
            Add server</a></li>
            <li><a href="#!" class="syncup"><i class="fas fa-sync-alt"></i>&nbsp;
            Sync</a></li>
            <li><a href="#!" class="followsomeone"><i class="fas fa-user-plus"></i>&nbsp;
            Follow someone</a></li>
            <li><a href="#!" class="blocksomeone"><i class="fas fa-user-times"></i>&nbsp;
            Block someone</a></li>
            <li><a href="#!" class="eraseprofile"><i class="fas fa-trash-alt"></i>&nbsp;
            Erase profile</a></li>

          </ol>
        </div>


        <div class="sidebar-module following">
          <h5>Following (<span>0</span>)</h5>
          <ol class="list-unstyled users-list">
            <!-- <li><a href="#!" class="activatenamemodal publickey" data-name="Name" data-publickey="PublicKey" data-content="Profile" data-image="/img/"><div class="publickey"><img src="/img/Image" class="align-middle profile-pic">Name<small>PublicKey</small></div></a></li> -->
          </ol>
        </div>
        <div class="sidebar-module followers">
          <h5>Followers (<span>0</span>)</h5>
          <ol class="list-unstyled users-list"></ol>
        </div>
        <div class="sidebar-module friends">
          <h5>Friends (<span>0</span>)</h5>
          <ol class="list-unstyled users-list"></ol>
        </div>
        <div class="sidebar-module connections">
          <h5>Connections (<span>0</span>)</h5>
          <ol class="list-unstyled users-list"></ol>
        </div>
        <div class="sidebar-module blocked">
          <h5>Blocked (<span>0</span>)</h5>
          <ol class="list-unstyled users-list"></ol>
        </div>



      </aside>
      <!-- /.blog-sidebar -->
    </div>
    <!-- /.row -->
  </main>
  <!-- /.container -->
  <footer class="blog-footer">
    <p>Blog template built for <a href="https://getbootstrap.com/">Bootstrap</a> by <a href="https://twitter.com/mdo">@mdo</a>.</p>
    <p>
      <a href="#">Back to top</a>
    </p>
  </footer>
  <!-- Bootstrap core JavaScript
    ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
  <script src="/static/jquery-3.2.1.min.js"></script>
  <script src="/static/popper.min.js"></script>
  <script src="/static/bootstrap.min.js"></script>
  <script src="/static/medium-editor.min.js"></script>
  <script src="/static/toastr.min.js"></script>
  <script>

var KiKiApi = function() {}

KiKiApi.prototype.fetch = function(ajaxObj){
    $.ajax(ajaxObj);
}

KiKiApi.prototype.onError = function(toast_msg, callback){
    return function(xhr, status, err) {
        if (xhr.responseJSON.error) {
            err = xhr.responseJSON.error;
        }
        toast_msg && toastr.error(err, toast_msg || 'Error');
        if (!err.stack) {
            err = new Error(err)
        }
        callback && callback(err);
    }
}

KiKiApi.prototype.onSuccess = function(toast_msg, callback){
    return function(data, status, xhr) {
        if ("ok" != data.status) {
            toast_msg && toastr.error(data.error, toast_msg || 'Error');
            callback && callback(new Error(data.error));
        }
        toast_msg && toastr.success(data.message, toast_msg);
        callback && callback(null, data);
    }
}

KiKiApi.prototype.submitLetter = function(letter, callback) {
    var self = this;
    var toast_msg = "Posting to KiKi";
    $.ajax({
        url: "/letter",
        method: "POST",
        data: JSON.stringify(letter),
        contentType: "application/json",
        error: self.onError(toast_msg, callback),
        success: self.onSuccess(toast_msg, callback)
    });
}

KiKiApi.prototype.likePost = function(post_id) {
    this.submitLetter({
        "purpose": "action-like",
        "to": ["public"],
        "content": post_id,
    });
}

KiKiApi.prototype.followUser = function(user_id) {
    this.submitLetter({
        "purpose": "action-follow",
        "to": ["public"],
        "content": user_id,
    });
}

KiKiApi.prototype.fetchPosts = function(callback) {
    var self = this;
    $.ajax({
        url: "/api/v1/posts",
        method: "GET",
        error: self.onError(null, callback),
        success: self.onSuccess(null, callback)
    });
}

KiKiApi.prototype.fetchPost = function(post_id, callback) {
    var self = this;
    $.ajax({
        url: "/api/v1/post/"+post_id,
        method: "GET",
        error: self.onError(null, callback),
        success: self.onSuccess(null, callback)
    });
}

KiKiApi.prototype.fetchPostComments = function(post_id, callback) {
    var self = this;
    $.ajax({
        url: "/api/v1/post/"+post_id+"/comments",
        method: "GET",
        error: self.onError(null, callback),
        success: self.onSuccess(null, callback)
    });
}

KiKiApi.prototype.fetchUser = function(user_id, callback) {
    var self = this;
    var url = "/api/v1/user"
    if (user_id) {
        url += "/"+user_id
    }
    $.ajax({
        url: url,
        method: "GET",
        error: self.onError(null, callback),
        success: self.onSuccess(null, callback)
    });
}




var KiKiClient = function(api, callback){
    this.api = api;
    this.posts = [];
    this.users = {};
    this.primary = {};
    this.$el = $("#posts");
    this.init(callback);
}

KiKiClient.prototype.collectUsersFromPost = function(post) {
    this.addUser(post.owner_id);
    if (post.recipients) {
        for (var i=0; i<post.recipients.length; i++) {
            this.addUser(post.recipients[i]);
        }
    }
}

KiKiClient.prototype.buildPostCommentsUi = function(post_id) {
    var self = this;
    this.api.fetchPostComments(post_id, function(err, res){
        if (err) throw err;
        // recursive build
        var post_comments = [];
        $('.post-container[post_id="'+post_id+'"] .post-comments').html('');
        $('.post-container[post_id="'+post_id+'"] .post-comments').append(
            (function(){
                var elems = [];
                for (var i=0; i<res.data.posts.length; i++) {
                    var post = res.data.posts[i];
                    if (0 != post.num_comments) {
                        post_comments.push(post.id);
                    }

                    self.collectUsersFromPost(post);

                    elems.push(
                        $("<div>", {post_id: post.id}).addClass('post-container').append(
                            $('<div>').addClass('col-12').append(
                                self.buildPostElem(post)
                            )
                        )
                    );
                }
                return elems;
            })()
        );

        // fetch posts comment comments
        for (var i=0; i<post_comments.length; i++) {
            self.buildPostCommentsUi(post_comments[i]);
        }

        self.buildUsersUi();

    });
};

KiKiClient.prototype.openModal = function(event) {
    $("#writingModal").modal();
    $("#writingModalLabel").text($(this).data('title'));
    $(".editable").focus(function() {
        $(this).select();
    });
    if ($(this).data("usecontent")) {
        $(".editable").html($("#" + $(this).data("usecontent")).html())
    } else {
        $(".editable").text("Write your post...");
    }
    if ($(this).data("makecontent")) {
        $(".editable").html($(this).data("makecontent"));
    }
    if ($(this).data("replyto")) {
        $("#letterReplyTo").val($(this).data("replyto"));
    } else {
        $("#letterReplyTo").val("");
    }
    if ($(this).data("replaces")) {
        $("#letterReplaces").val($(this).data("replaces"));
    } else {
        $("#letterReplaces").val("");
    }
    $("#letterPurpose").val($(this).data("purpose"));
}

KiKiClient.prototype.buildPostElem = function(post) {
    var self = this;
    return $("<div>").append(
        $("<div>").addClass("post-header").append(
            $("<span>").addClass("float-right").append(
                "&nbsp;",
                $("<a>", {
                    'href': "#!",
                    'title': "Reply to " + post.owner_name,
                    'data-title': "Reply to " + post.owner_name,
                    'data-replyto': post.id,
                    'data-purpose':"share-text"
                }).addClass("editmodal").append(
                    $('<i>').addClass("fas fa-reply")
                ).on('click', this.openModal),
                "&nbsp;",

                // edit button
                (function() {
                    // only display if current user owns the post
                    if (post.owner_id == app.User.public_key) {
                        return [
                                $("<a>", {
                                'href': "#!",
                                'title': "Edit post",
                                'data-title':"Edit post",
                                'data-usecontent':post.id,
                                'data-replaces':post.id,
                                'data-purpose':"share-text"

                            }).addClass("editmodal").append(
                                $("<i>").addClass("fas fa-edit")
                            ).on('click', this.openModal),
                            "&nbsp;"
                        ];
                    }
                })(),
                //.end

                // like button
                $("<a>",  {
                        'href': "#!",
                        "data-id":post.id
                    }).addClass("likebutton").append(
                        $("<i>").addClass("fas fa-heart"),
                        "x"+(post.likes||0)
                    ).on('click', function() {
                        self.api.likePost(post.id);
                    })
                //.end

            ),

            $("<img>", {
                owner_id: post.owner_id
            }).addClass("align-middle profile-pic"),

            // activatenamemodal
            $("<a>",{
                'href':"#!",
                'data-publickey': post.owner_id,
            }).addClass("activatenamemodal").append(
                 post.owner_name || post.owner_id
            ).on('click', function() {
                var user = app.Client.getUser($(this).data('publickey'));
                if (user) {
                    $("#modalNameName").text(user.name || user.public_key);

                    $("#modalNamePublicKey").text("");
                    if (user.name) {
                        $("#modalNamePublicKey").text(user.public_key);
                    }

                    $("#modalNameContent").html(user.profile);

                    $("#modalNameImage").attr("src", null);
                    if (user.image && "" != user.image) {
                        $("#modalNameImage").attr("src", '/img/'+user.image);
                    }

                    $("#nameModal").modal();
                    $("#followButton").attr("data-publickey", user.public_key);
                }
            }),
            //.end

            // recipients
            " to ",
            (function(){
                var elems = [];
                for (var i=0; i<post.recipients.length; i++) {
                    elems.push(
                        $("<span>", {
                            owner_id: post.recipients[i]
                        }).addClass('recipient').append(post.recipients[i])
                    );
                }
                return elems;
            })(),
            //.end

            "<br>",
            $("<span>").addClass('text-muted post-datetime').append(
                $('<a>', {href:'/?id='+post.id}).append(
                    new Date(post.timestamp*1000)
                )
            )
        ),

        $('<div>', {id:post.id}).append(post.content),
        $('<div>').addClass('post-comments row')
    );
}


KiKiClient.prototype.buildPostUi = function(post) {
    var self = this;
    return $("<div>", {post_id: post.id}).addClass("card post-container").append(
        $("<div>").addClass("card-body").append(
            self.buildPostElem(post)
        )
    );
}

KiKiClient.prototype.addUser = function(user_id, user_data) {
    if (!this.users[user_id]) {
        this.users[user_id] = user_data;
    } else if (user_data) {
        this.users[user_id] = user_data;
    }
    // add/update ui info
    if (user_data) {
        if (user_data && "" != user_data.image) {
            $('img.profile-pic[owner_id="'+user_data.public_key+'"]').attr('src', '/img/'+user_data.image);
        }
        $('span.recipient[owner_id="'+user_data.public_key+'"]').text(
            user_data.name || user_data.public_key
        );
    }
}

KiKiClient.prototype.getUser = function(user_id) {
    if (!this.users[user_id]) return null;
    return this.users[user_id];
}

KiKiClient.prototype.buildPostsUi = function(callback) {
    for (var i=0; i<this.posts.length; i++) {
        var post = this.posts[i];
        this.$el.append(
            this.buildPostUi(post)
        );

        if (0 != post.num_comments) {
            this.buildPostCommentsUi(post.id);
        }

        this.collectUsersFromPost(post);
    }

    this.buildUsersUi();
}

KiKiClient.prototype.buildUsersUi = function() {
    var self = this;
    for (var i in this.users) {
        if (!this.users[i]) {
            this.api.fetchUser(i, function(err,res){
                if (err) throw err;
                var user_data = res.data.user;
                self.addUser(user_data.public_key, user_data);
            });
        }
    }
}

KiKiClient.prototype.init = function(callback){
    var self = this;
    $('.user-info .editmodal').on('click', this.openModal);
    $("#followButton").click(function() {
        self.api.followUser($(this).data("publickey"));
    });
    this.api.fetchPosts(function(err,res){
        if (err) {
            throw err;
        }
        self.posts = res.data.posts;
        self.buildPostsUi();
    });
    callback && callback();
}




var UserClient = function(api) {
    this.data = {};
    this.api = api;
    this.init();
}

UserClient.prototype.init = function() {
    var self = this;
    this.api.fetchUser(null, function(err,res){
        if (err) throw err;
        self.data = res.data.user;
        self.buildUserUi();
    });
}

UserClient.prototype.buildUserUi = function(){
    if (this.data) {
        $("#user-name").text( this.data.name || this.data.public_key );
        $("#user-profile").html("");
        $("#user-profile").append( this.data.profile );
        if (this.data.image && "" != this.data.image) {
            $("#user-profile-image").attr("src", "/img/"+ this.data.image);
        }

        $(".following span").text(this.data.following.length);
        $(".followers span").text(this.data.followers.length);
        $(".friends span").text(this.data.friends.length);
        $(".blocked span").text(this.data.blocked.length);
        // $(".connections span").text(this.data.connections.length);

        // <li><a href="#!" class="activatenamemodal publickey" data-name="Name" data-publickey="PublicKey" data-content="Profile" data-image="/img/"><div class="publickey"><img src="/img/Image" class="align-middle profile-pic">Name<small>PublicKey</small></div></a></li>
        // <div class="sidebar-module followers">
        //   <h5>Followers (<span>0</span>)</h5>
        //   <ol class="list-unstyled"></ol>
        // </div>
        // <div class="sidebar-module friends">
        //   <h5>Friends (<span>0</span>)</h5>
        //   <ol class="list-unstyled"></ol>
        // </div>
        // <div class="sidebar-module connections">
        //   <h5>Connections (<span>0</span>)</h5>
        //   <ol class="list-unstyled"></ol>
        // </div>
        // <div class="sidebar-module blocked">
        //   <h5>Blocked (<span>0</span>)</h5>
        //   <ol class="list-unstyled"></ol>
        // </div>

    }
}









var app = {}
app.Api = new KiKiApi();
app.Client = new KiKiClient(app.Api);
app.User = new User(app.Api);


var updateInterval = setInterval(function(){
    console.log("update page");
},10000);








    toastr.options = {
      "closeButton": true,
      "debug": false,
      "newestOnTop": false,
      "progressBar": false,
      "positionClass": "toast-bottom-center",
      "preventDuplicates": false,
      "onclick": null,
      "showDuration": "300",
      "hideDuration": "1000",
      "timeOut": "5000",
      "extendedTimeOut": "1000",
      "showEasing": "swing",
      "hideEasing": "linear",
      "showMethod": "fadeIn",
      "hideMethod": "fadeOut"
    }
    var editor = new MediumEditor('.editable', {
      toolbar: {
        relativeContainer: document.querySelector("#writingModalBody"),
        allowMultiParagraphSelection: true,
        buttons: ['bold', 'italic', 'underline', 'anchor', 'h2', 'h3', 'quote'],
        diffLeft: 0,
        diffTop: -10,
        firstButtonClass: 'medium-editor-button-first',
        lastButtonClass: 'medium-editor-button-last',
        standardizeSelectionStart: false,
        static: true,
        autoLink: true,
        /* options which only apply when static is true */
        align: 'center',
        sticky: false,
        updateOnEmptySelection: false
      }
    });
    $(document).ready(function() {
      $("img").addClass("img-fluid");
      $("#submit-writing").click(function(event) {
        // Stop form from submitting normally
        event.preventDefault();
        letter = {
          "purpose": $("#letterPurpose").val(),
          "replaces": $("#letterReplaces").val(),
          "reply_to": $("#letterReplyTo").val(),
          "to": ["self"],
          "content": editor.getContent(),
        }
        if ($("#writingToPublic").is(":checked") == true) {
          letter["to"] = ["public"];
        }
        if ($("#writingToFriends").is(":checked") == true) {
          letter["to"] = ["friends"];
        }
        console.log(letter);
        app.Api.submitLetter(letter);
      });


      $(".syncup").click(function(event){
        event.preventDefault();
        var posting = $.post( "/sync",JSON.stringify({ "address": "" })  );
        posting.done(function( data ) {
          toastr["success"](data['message'], "Updating Kiki");
        });
      })

      $(".addserver").click(function(event){
        event.preventDefault();
        var server = prompt("Enter a server to connect to", "https://kiki.network");
        if (server != null) {
          // Send the data using post
         var posting = $.post( "/sync", JSON.stringify({ "address": server }) );
         // Put the results in a div
         posting.done(function( data ) {
           console.log(data);
           toastr["success"](data['message'], "Updating Kiki");
         });
        }
      })




      var restrictInput = function(event) {
        $("img:not(.img-fluid)").addClass("img-fluid");
      }
      editor.on(document.querySelector(".editable"), 'keypress', restrictInput);






      // SCROLL TO TOP
      $('body').append(
          $('<div>', {id: 'toTop'})
                .css({
                    'position': 'fixed',
                    'bottom': '20px',
                    'right': '40px',
                    'cursor': 'pointer',
                    'display': 'none'
                })
                .addClass('btn btn-info')
                .append(
                    $('<i>').addClass('fa fa-chevron-up')
                ).on('click', function(){
                    $("html, body").animate({ scrollTop: 0 }, 600);
                })
      );
        $(window).scroll(function () {
            if ($(this).scrollTop() != 0) {
                $('#toTop').fadeIn();
            } else {
                $('#toTop').fadeOut();
            }
        });



    });
  </script>
</body>

</html>
