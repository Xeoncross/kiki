<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">
  <link rel="icon" href="../../../../favicon.ico">
  <title>Kiki</title>
  <!-- Bootstrap core CSS -->
  <link href="/static/bootstrap.min.css" rel="stylesheet">
  <!-- Custom styles for this template -->
  <link href="/static/blog.css" rel="stylesheet">
  <script defer src="/static/all.js"></script>
  <link href="/static/toastr.css" rel="stylesheet" />
  <link rel="stylesheet" href="/static/medium-editor.min.css" type="text/css" media="screen" charset="utf-8">
  <link href="/static/bootstrap.medium.css" rel="stylesheet" />
</head>

<body>
  <header>
    <div class="blog-masthead">
      <div class="container">
        <nav class="nav">
          <a class="nav-link active" href="/">Kiki</a>
          <!-- <a class="nav-link" href="#">Help</a>
          <a class="nav-link" href="#">About</a> -->
        </nav>
      </div>
    </div>
    <!--         <div class="blog-header">
                <div class="container">
                    <h1 class="blog-title">The Bootstrap Blog</h1>
                    <p class="lead blog-description">An example blog template built with Bootstrap.</p>
                </div>
            </div>
        -->
  </header>
  <main role="main" class="container">
    <input type=hidden id="letterPurpose" value="" />
    <input type=hidden id="letterReplyTo" value="" />
    <input type=hidden id="letterReplaces" value="" />
    <!-- begin medium modal -->
    <!-- Modal -->
    <div class="modal fade" id="writingModal" role="dialog" aria-labelledby="writingModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content"  id="writingModalBody">
          <div class="modal-header">
            <h5 class="modal-title" id="writingModalLabel"></h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
          </div>
          <div class="modal-body">
            <div class="editable">
              <p>My fatherâ€™s family name being
                <a href="https://en.wikipedia.org/wiki/Pip_(Great_Expectations)">Pirrip</a>, and my Christian name Philip, my infant tongue could make of both names nothing longer or more explicit than Pip. So, I called myself Pip, and came to be called
                Pip.
              </p>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <div class="btn-group btn-group-toggle" data-toggle="buttons">
              <label class="btn btn-info">
                                        <input type="radio" name="options" id="writingToSelf" autocomplete="off">Self
                                    </label>
              <label class="btn btn-info">
                                        <input type="radio" name="options" id="writingToFriends" autocomplete="off"> Friends
                                    </label>
              <label class="btn btn-info active">
                                        <input type="radio" name="options" id="writingToPublic" autocomplete="off" checked> Public
                                    </label>
            </div>
            <button type="button" class="btn btn-primary" id="submit-writing">Submit</button>
          </div>
        </div>
      </div>
    </div>
    <!-- end medium modal -->
    <!-- Modal -->
    <div class="modal fade" id="nameModal" role="dialog" aria-labelledby="nameModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="nameModalLabel"><img id="modalNameImage" src="" class="align-middle profile-pic">&nbsp;
                                <span id="modalNameName">Mark</span> <br><small class="text-muted" style="font-size: 70%;" id="modalNamePublicKey">aasdlkfjas9jf93jfa</small></h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                                </button>
          </div>
          <div class="modal-body">
            <span id="modalNameContent">
                                    I enjoy skiing and driving around!
                                </span>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-info">Message</button>
            <button type="button" class="btn btn-info">Filter</button>
            <button type="button" class="btn btn-primary" id="followButton">Follow</button>
            <button type="button" class="btn btn-danger">Block</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-sm-9 blog-main">
        {{ range .Posts }}
        <!--begin blog post -->
        <div class="card">
          <div class="card-body">
            <div class="blog-post">
              <p class="blog-post-meta">
                <span class="float-right">
                  &nbsp;
                  <a href="#!" class="editmodal" data-title="Reply to {{ .Post.User.Name }}" data-replyto="{{ .Post.ID }}" data-purpose="share-text"><i class="fas fa-reply"></i></a>
                  &nbsp;
                  <a href="#!" data-usecontent="{{.Post.ID}}" data-title="Edit post" class="editmodal" data-replaces="{{.Post.ID}}" data-purpose="share-text"><i class="fas fa-edit"></i></a>
                 &nbsp;
                <a href="#!" data-id="{{.Post.ID}}" class="likebutton"><i class="fas fa-heart"></i> {{ if gt .Post.Likes 1 }}x{{ .Post.Likes }}{{ end }}</a>
              </span>

                <img src="/img/{{ .Post.User.Image }}" class="align-middle profile-pic">
                <a href="#!" class="activatenamemodal" data-name="{{ .Post.User.Name }}" data-image="/img/{{ .Post.User.Image }}" data-publickey="{{ .Post.User.PublicKey }}" data-content="{{ .Post.User.Profile }}" data-image="/img/{{ .Post.User.Image }}">{{ if .Post.User.Name }}{{ .Post.User.Name }}{{ else }}{{ .Post.User.PublicKey }}{{ end }}</a>                to {{ .Post.Recipients }} <br> <span class="text-muted"><a href="/?id={{.Post.ID}}">{{ .Post.Date.Format "January 2, 2006 3:04:05PM" }}</a></span>
              </p>
              <hr>
              <div id="{{ .Post.ID }}">
                {{ .Post.Content }}
              </div>
              {{ if .Comments }}
              <hr>
                {{end}}
              {{ range .Comments }}
                <!-- simple comments -->
                <div data-children=".item"  style="font-size:80%;">
                  <!-- a single simple comment begins -->
                  <div class="row">
                    <div class="col-{{.Depth}}"></div>
                    <div class="col-{{ minus 12 .Depth}}">
                        <div class="item">
                            <div class="row">
                              <div class="col-12">

                                <span class="float-right"><a href="#!" class="editmodal" data-title="Reply to {{ .User.Name }}" data-replyto="{{ .ID }}" data-purpose="share-text"><i class="fas fa-reply"></i></a>&nbsp;

                                <a href="#!" data-usecontent="{{.ID}}" data-title="Edit post" class="editmodal" data-replaces="{{.ID}}" data-replyto="{{.ReplyTo}}" data-purpose="share-text"><i class="fas fa-edit"></i></a>&nbsp;
                              <a href="#!" data-id="{{.ID}}" class="likebutton"><i class="fas fa-heart"></i> {{ if gt .Likes 1 }}x{{ .Likes }}{{ end }}</a>
                            </span>

                                {{ if .User.Image }}<img src="/img/{{ .User.Image }}" class="align-middle profile-pic">{{ end }}
                                <a href="#!" class="activatenamemodal" data-name="{{ .User.Name }}" data-image="/img/{{ .User.Image }}" data-publickey="{{ .User.PublicKey }}" data-content="{{ .User.Profile }}" data-image="/img/{{ .User.Image }}">{{ if .User.Name }}{{ .User.Name }}{{ else }}{{ .User.PublicKey }}{{ end }}</a>                to {{ .Recipients }} <br> <span class="text-muted"><a href="/?id={{.ID}}">{{ .Date.Format "January 2, 2006 3:04:05PM" }}</a></span>

                              </div>
                            </div>
                            <div role="tabpanel">
                              <p class="mb-3">
                                <div id="{{ .ID }}">
                                {{ .Content }}
                              </div>
                              </p>
                            </div>
                          </div>
                    </div>
                  </div>
                  <!-- a single simple comment ends -->
                </div>
                <!-- end simple comments -->
              {{ end }}
            </div>
          </div>
        </div>
        <!-- /.blog-post -->
        {{ end }}
        <!-- end blog post -->


        <!-- /.blog-post -->
        <nav class="blog-pagination">
          <a class="btn btn-outline-primary" href="#">Older</a>
          <a class="btn btn-outline-secondary disabled" href="#">Newer</a>
        </nav>
      </div>
      <!-- /.blog-main -->
      <aside class="col-sm-3 ml-sm-auto blog-sidebar">
        <div class="sidebar-module sidebar-module-inset">
          <img src="/img/{{ .User.Image }}">
          <h4><div id="current-name">{{ .User.Name }}</div></h4>
          <div id="current-profile">
            {{ .User.Profile }}
          </div>
        </div>
        <div class="sidebar-module">
          <h4>Actions</h4>
          <ol class="list-unstyled">
            <li><a href="#!" class="editmodal" data-title="Write a post" data-purpose="share-text">Write</a></li>
            <li><a href="#!" class="editmodal" data-title="Edit profile" data-purpose="action-assign/profile" data-usecontent="current-profile">Edit profile</a></li>
            <li><a href="#"  class="editmodal" data-title="Update image" data-purpose="action-assign/image" data-makecontent="Drag and drop an image...">Upload image</a></li>
            <li><a href="#!" class="editmodal" data-title="Change name" data-purpose="action-assign/name" data-usecontent="current-name">Change name</a></li>
          </ol>
        </div>
        <div class="sidebar-module">
          <h4>Following  ({{ len .Friends.Following }})</h4>
          <ol class="list-unstyled">
            {{ range .Friends.Following }}
            <li><a href="#!" class="activatenamemodal" data-name="{{ .Name }}" data-image="/img/{{ .Image }}" data-publickey="{{ .PublicKey }}" data-content="{{ .Profile }}" data-image="/img/{{ .Image }}">{{ if .Name }}{{ .Name }}{{ else }}<small>{{ .PublicKey }}</small>{{ end }}</a></li>
            {{ end }}
          </ol>
        </div>
        <div class="sidebar-module">
          <h4>Followers  ({{ len .Friends.Followers }})</h4>
          <ol class="list-unstyled">
            {{ range .Friends.Followers }}
            <li><a href="#!" class="activatenamemodal" data-name="{{ .Name }}" data-image="/img/{{ .Image }}" data-publickey="{{ .PublicKey }}" data-content="{{ .Profile }}" data-image="/img/{{ .Image }}">{{ if .Name }}{{ .Name }}{{ else }}<small>{{ .PublicKey }}</small>{{ end }}</a></li>
            {{ end }}
          </ol>
        </div>
        <div class="sidebar-module">
          <h4>Friends ({{ len .Friends.Friends }})</h4>
          <ol class="list-unstyled">
            {{ range .Friends.Friends }}
            <li><a href="#!" class="activatenamemodal" data-name="{{ .Name }}" data-image="/img/{{ .Image }}" data-publickey="{{ .PublicKey }}" data-content="{{ .Profile }}" data-image="/img/{{ .Image }}">{{ if .Name }}{{ .Name }}{{ else }}<small>{{ .PublicKey }}</small>{{ end }}</a></li>
            {{ end }}
          </ol>
        </div>
          <div class="sidebar-module">
            <h4>Connections ({{ len .Connected }})</h4>
            <ol class="list-unstyled">
              {{ range .Connected }}
              <li><a href="#!" class="activatenamemodal" data-name="{{ .Name }}" data-image="/img/{{ .Image }}" data-publickey="{{ .PublicKey }}" data-content="{{ .Profile }}" data-image="/img/{{ .Image }}">{{ .Server }}</a></li>
              {{ end }}
            </ol>
        </div>
        
      </aside>
      <!-- /.blog-sidebar -->
    </div>
    <!-- /.row -->
  </main>
  <!-- /.container -->
  <footer class="blog-footer">
    <p>Blog template built for <a href="https://getbootstrap.com/">Bootstrap</a> by <a href="https://twitter.com/mdo">@mdo</a>.</p>
    <p>
      <a href="#">Back to top</a>
    </p>
  </footer>
  <!-- Bootstrap core JavaScript
    ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
  <script src="/static/jquery-3.2.1.min.js"></script>
  <script src="/static/popper.min.js"></script>
  <script src="/static/bootstrap.min.js"></script>
  <script src="/static/medium-editor.min.js"></script>
  <script src="/static/toastr.min.js"></script>
  <script>
  function submitLetter(letter, callback) {

      function onError(data) {
          toastr["error"](data.error, "Posting to KiKi")
      }

      $.ajax({
          url: "/letter",
          method: "POST",
          data: JSON.stringify(letter),
          contentType: "application/json",
          error: function(xhr, status, err) {
              try {
                  var err_json = xhr.responseJSON.error;
                  toastr["error"](err_json, "Posting to KiKi");
                  callback && callback(new Error(err_json));
              }
              catch(error) {
                  toastr["error"](err, "Posting to KiKi");
                  callback && callback(err);
              }
          },
          success: function(data, status, xhr) {
              if ("ok" != data.status) {
                  // hhtp headers
                  callback && callback(new Error(data.error));
                  return onError(data);
              }
              toastr["success"](data['message'], "Posting to KiKi");
              callback && callback(null, data);
          }
      });

  }


var KiKiApi = function() {}

KiKiApi.prototype.fetch = function(ajaxObj, callback){
    $.ajax(ajaxObj);
}

KiKiApi.prototype.onError = function(){}

KiKiApi.prototype.onSuccess = function(){}

KiKiApi.prototype.submitLetter = function(letter, callback) {

}

var app = {
    Api: new KiKiApi()
}




    toastr.options = {
      "closeButton": true,
      "debug": false,
      "newestOnTop": false,
      "progressBar": false,
      "positionClass": "toast-bottom-center",
      "preventDuplicates": false,
      "onclick": null,
      "showDuration": "300",
      "hideDuration": "1000",
      "timeOut": "5000",
      "extendedTimeOut": "1000",
      "showEasing": "swing",
      "hideEasing": "linear",
      "showMethod": "fadeIn",
      "hideMethod": "fadeOut"
    }
    var editor = new MediumEditor('.editable', {
      toolbar: {
        relativeContainer: document.querySelector("#writingModalBody"),
        allowMultiParagraphSelection: true,
        buttons: ['bold', 'italic', 'underline', 'anchor', 'h2', 'h3', 'quote'],
        diffLeft: 0,
        diffTop: -10,
        firstButtonClass: 'medium-editor-button-first',
        lastButtonClass: 'medium-editor-button-last',
        standardizeSelectionStart: false,
        static: true,
        autoLink: true,
        /* options which only apply when static is true */
        align: 'center',
        sticky: false,
        updateOnEmptySelection: false
      }
    });
    $(document).ready(function() {
      $("img").addClass("img-fluid");
      $("#submit-writing").click(function(event) {
        // Stop form from submitting normally
        event.preventDefault();
        letter = {
          "purpose": $("#letterPurpose").val(),
          "replaces": $("#letterReplaces").val(),
          "reply_to": $("#letterReplyTo").val(),
          "to": ["self"],
          "content": editor.getContent(),
        }
        if ($("#writingToPublic").is(":checked") == true) {
          letter["to"] = ["public"];
        }
        if ($("#writingToFriends").is(":checked") == true) {
          letter["to"] = ["friends"];
        }
        console.log(letter);
        submitLetter(letter);
	      $("#writingModal").modal('hide');
      });
      $(".editmodal").click(function() {
        $("#writingModal").modal();
        console.log($(this).data('title'));
        $("#writingModalLabel").text($(this).data('title'));
        $(".editable").focus(function() {
          $(this).select();
        });
        console.log($(this).data("usecontent"));
        if ($(this).data("usecontent")) {
          $(".editable").html($("#" + $(this).data("usecontent")).html())
        } else {
          $(".editable").text("Write your post...");
        }
        if ($(this).data("makecontent")) {
          $(".editable").html($(this).data("makecontent"));
        }
        if ($(this).data("replyto")) {
          $("#letterReplyTo").val($(this).data("replyto"));
        } else {
          $("#letterReplyTo").val("");
        }
        if ($(this).data("replaces")) {
          $("#letterReplaces").val($(this).data("replaces"));
        } else {
          $("#letterReplaces").val("");
        }
        $("#letterPurpose").val($(this).data("purpose"));
      });
      $(".activatenamemodal").click(function(event) {
        event.preventDefault();
        console.log($(this).data("name"));
        $("#modalNameName").text($(this).data("name"));
        $("#modalNamePublicKey").text($(this).data("publickey"));
        $("#modalNameContent").html($(this).data("content"));
        $("#modalNameImage").attr("src",$(this).data("image"));
        $("#nameModal").modal();
        $("#followButton").attr("data-publickey", $(this).data("publickey"));
      });
      $("#followButton").click(function(event) {
        console.log($(this).data("publickey"));
        letter = {
          "purpose": "action-follow",
          "to": ["public"],
          "content": $(this).data("publickey"),
        };
        submitLetter(letter);
        $("#nameModal").modal('hide');
      });
      $(".likebutton").click(function(event) {
        console.log($(this).data("id"));
        event.preventDefault();
        letter = {
          "purpose": "action-like",
          "to": ["public"],
          "content": $(this).data("id"),
        };
        submitLetter(letter);
      });

      var restrictInput = function(event) {
        $("img:not(.img-fluid)").addClass("img-fluid");
      }
      editor.on(document.querySelector(".editable"), 'keypress', restrictInput);
    });
  </script>
</body>

</html>
